# ============================================
# [PROJECT_NAME] — Auto-deploy a VPS on push
# ============================================
# Flujo: Push → Empaqueta → SCP al VPS → Rebuild Docker → Health check
#
# GitHub Secrets necesarios:
#   VPS_HOST     — IP del VPS (ej: 195.35.2.150)
#   VPS_USER     — Usuario SSH (ej: deploy)
#   VPS_SSH_KEY  — Clave privada SSH (contenido completo del archivo)
#
# Para configurar:
#   1. Crear clave SSH: ssh-keygen -t ed25519 -C "actions@[PROJECT]" -f ~/.ssh/id_ed25519_[PROJECT]_actions -N ""
#   2. Copiar publica al VPS: ssh-copy-id -i ~/.ssh/id_ed25519_[PROJECT]_actions.pub deploy@VPS_IP
#   3. Configurar secrets en GitHub:
#      gh secret set VPS_HOST --repo OWNER/REPO
#      gh secret set VPS_USER --repo OWNER/REPO
#      gh secret set VPS_SSH_KEY --repo OWNER/REPO < ~/.ssh/id_ed25519_[PROJECT]_actions

name: Deploy to VPS

on:
  push:
    branches:
      - main
      # Descomentar para branch de produccion separada:
      # - release/production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Package project
        run: |
          tar -czf /tmp/project.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='__pycache__' \
            --exclude='.env.*' \
            --exclude='!.env.*.example' \
            --exclude='.tmp' \
            --exclude='*.pyc' \
            .
          ls -lh /tmp/project.tar.gz

      - name: Upload to VPS
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            /tmp/project.tar.gz \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/project.tar.gz

      - name: Deploy on VPS
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'DEPLOY'
            set -e
            APP_DIR=~/apps/[PROJECT]
            cd $APP_DIR

            # Extraer nuevo codigo
            tar -xzf /tmp/project.tar.gz
            rm /tmp/project.tar.gz

            # Rebuild y restart
            docker compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.prod build
            docker compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.prod up -d

            # Limpiar imagenes viejas
            docker image prune -f
          DEPLOY

      - name: Health check
        run: |
          sleep 10
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "curl -sf http://localhost:8000/api/health || exit 1"
          echo "Deploy successful!"
